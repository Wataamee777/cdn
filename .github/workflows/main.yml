name: Generate index, sitemap, ogp

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate index.html & sitemap.xml
        shell: bash
        run: |
          set -e

          BASE_URL="https://cdn.wata777.f5.si"
          SITEMAP="sitemap.xml"

          EXCLUDE_DIRS=(
            "./.git"
            "./.github"
            "./node_modules"
          )

          is_excluded() {
            for d in "${EXCLUDE_DIRS[@]}"; do
              [[ "$1" == "$d"* ]] && return 0
            done
            return 1
          }

          echo '<?xml version="1.0" encoding="UTF-8"?>' > "$SITEMAP"
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> "$SITEMAP"

          while IFS= read -r dir; do
            is_excluded "$dir" && continue

            INDEX="$dir/index.html"
            REL="${dir#./}"
            [ "$REL" = "" ] && REL="/"

            NAME="$(basename "$dir")"
            [ "$NAME" = "." ] && NAME="home"
            TITLE="${NAME} - cdn"

            URL_PATH="${REL#/}"
            PAGE_URL="$BASE_URL/$URL_PATH"
            PAGE_URL="${PAGE_URL%/}/"

            if [ ! -f "$INDEX" ]; then
              {
                echo '<!DOCTYPE html>'
                echo '<html lang="ja">'
                echo '<head>'
                echo '  <meta charset="UTF-8">'
                echo "  <title>$TITLE</title>"
                echo '  <meta property="og:type" content="website">'
                echo "  <meta property=\"og:title\" content=\"$TITLE\">"
                echo "  <meta property=\"og:url\" content=\"$PAGE_URL\">"
                echo '  <meta property="og:site_name" content="cdn">'
                echo '  <meta name="viewport" content="width=device-width, initial-scale=1">'
                echo '</head>'
                echo '<body>'
                echo "  <h1>$TITLE</h1>"
                echo '  <ul>'
              } > "$INDEX"

              while IFS= read -r item; do
                name="$(basename "$item")"
                if [ -d "$item" ]; then
                  echo "    <li><a href=\"./$name/\">$name/</a></li>" >> "$INDEX"
                else
                  echo "    <li><a href=\"./$name\">$name</a></li>" >> "$INDEX"
                fi
              done < <(find "$dir" -maxdepth 1 -mindepth 1)

              {
                echo '  </ul>'
                echo '</body>'
                echo '</html>'
              } >> "$INDEX"
            fi

            echo "  <url><loc>$PAGE_URL</loc></url>" >> "$SITEMAP"

          done < <(find . -type d)

          echo '</urlset>' >> "$SITEMAP"

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --cached --quiet || git commit -m "auto: generate index, ogp, sitemap"
          git push
